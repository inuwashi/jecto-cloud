{% extends "base.html" %}

{% load staticfiles %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block title %}{{ block.super }}Home{% endblock %}

{% block styles %}
<link href="{% static 'site/css/jquery.bootgrid.min.css' %}" rel="stylesheet">

{% endblock styles %}


{% block navbar-left %}
  {% include "_navbar.html" with active_link="home" %}
{% endblock %}

{% block splash %}
<div class="short-jumbo">
    <div class="container">
      <div class="row">
        <div class="col-md-8 col-sm-8">
            <h1>Your Injections</h1>
        </div>
      </div>
    </div>
  </div>
{% endblock splash %}

{% block container %}
<!-- Benefits of the Django application -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
          <h3>Hello {{ user.name }},</h3>
          <p class="lead">Your last injection was {{ last_injection.date|naturalday }}.</p>
          {% if should_inject %}
            <h4 class="text-success">Yous should inject today.</h4>
          {% else %}
            <h4>Your next injection should be {{ next_injection_date|naturalday }}.</h4>
          {% endif %}
        </div>
      </div>
  <div class="row">
    <div class="col-lg-6">
      <h2>Record Injection</h2>
      Click on the injection site to record the injection. <br>
      The greener a site is, the safer it is.
      <div class='text-center' style="width: 100%">
        <div id='vitruvian_map' style='background-image: url("{% static '/site/img/Vitruvian_man.jpg' %}");  background-repeat: no-repeat; height:308px; width:308px;'>
          {% for site in sites %}
            <div class = "site-marker" style = "position: absolute; top: {{ site.pos_x }}px; left: {{ site.pos_y }}px;">
            <a class="inject" title="{{ site.name }}">
              <span class="circle" style="color: {{ site.color}};"></span>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>  
    </div>
    <div class="col-lg-6">
      <h2>Recent Injection History</h2>
      <table id="injection-history-grid" class="table table-condensed table-hover table-striped">
        <thead>
          <tr>
            <th data-column-id="date" data-formatter="date">Date</th>
            <th data-column-id="site">Injection Site</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>

{% endblock container %}

{% block scripts %}
<script src="{% static 'site/js/site.js' %}"></script>
<script src="{% static 'site/js/jquery.bootgrid.min.js' %}"></script>

<script>
// load the injection history into the table.
$("#injection-history-grid").bootgrid({
  navigation : 0,
  ajax: true,
  url: "/api/injections/",
  ajaxSettings: {
    method: "GET",
    cache: false
  },
  formatters: {
    "date": function(column, row) {
      var date = Date.parse(row.date);
      var delta = Math.round((+new Date - date) / 1000);
      var minute = 60,
          hour = minute * 60,
          day = hour * 24,
          week = day * 7;
      var fuzzy;
      
      if (delta < day) {
        fuzzy = "Today";
      } else if (delta < day * 2) {
        fuzzy = 'Yesterday';
      } else if (delta < day * 3) {
        fuzzy = 'Two days ago';
      } else {
        fuzzy = date;
      }
      return fuzzy;
    }
  }
});


// Get todays date
var d = new Date();
var month = d.getMonth()+1;
var day = d.getDate();
var today_string = d.getFullYear() + '-' +
    ((''+month).length<2 ? '0' : '') + month + '-' +
    ((''+day).length<2 ? '0' : '') + day;



$(".inject").on("click", function(){
  $.ajax({
    type: 'POST',
    url: "/api/injections/",
    data: JSON.stringify({
      site : $( this ).attr( 'title' ),
      date : today_string
    }), 
    success: function(data) { 
      $("#injection-history-grid").bootgrid("reload");
      console.log(data); 
      },
    contentType: "application/json",
    dataType: 'json'
});


})
</script>

{% endblock scripts %}